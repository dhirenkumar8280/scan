name: Fork, Sync, and Scan Public Repositories

on:
  push:
    branches:
      - main  # Trigger on pushes to main branch

  schedule:
    - cron: '0 * * * *'  # Runs every hour, adjust as needed

jobs:
  fork_and_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v2

      - name: Fork and Sync Repositories from repos.txt
        run: |
          mkdir -p cloned_repos
          
          # Loop through repos.txt
          while read repo_url; do
            repo_name=$(basename $repo_url .git)
            
            # Check if the repo is already forked (via GitHub CLI)
            if ! gh repo view $repo_name &>/dev/null; then
              echo "[+] Forking $repo_name"
              gh repo fork $repo_url --clone=false  # Fork without cloning
            else
              echo "[*] $repo_name already forked, checking for sync"
              # Fetch and sync the fork
              git clone --bare $repo_url cloned_repos/$repo_name
              cd cloned_repos/$repo_name
              git fetch upstream
              git checkout main
              git merge upstream/main  # Or master, based on the default branch
              git push origin main
              cd ../..
            fi
          done < repos.txt

      - name: Install TruffleHog
        run: |
          pip install trufflehog

      - name: Run TruffleHog SCA
        run: |
          # Loop through the cloned repos and scan them
          for dir in cloned_repos/*; do
            if [ -d "$dir" ]; then
              echo "[+] Scanning $dir with TruffleHog"
              trufflehog filesystem "$dir" --no-update --fail-criteria high || echo "[!] Secrets may exist in $dir"
            fi
          done

