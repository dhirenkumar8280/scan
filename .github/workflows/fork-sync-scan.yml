name: Clone and Scan Repositories

on:
  push:
    paths:
      - repos.txt

jobs:
  clone_and_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v2

      - name: Install Git and Download TruffleHog v3 Binary
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl

          echo "[+] Downloading TruffleHog v3 Linux binary"
          curl -sL https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_amd64.tar.gz -o trufflehog.tar.gz

          echo "[+] Extracting and installing"
          tar -xzf trufflehog.tar.gz
          sudo mv trufflehog /usr/local/bin/trufflehog
          chmod +x /usr/local/bin/trufflehog

      - name: Clone repositories from repos.txt
        run: |
          mkdir -p cloned_repos

          while IFS= read -r repo_url || [ -n "$repo_url" ]; do
            [[ -z "$repo_url" || "$repo_url" =~ ^# ]] && continue
            repo_name=$(basename "$repo_url" .git)
            rm -rf "cloned_repos/$repo_name"
            echo "[+] Cloning $repo_name"
            git clone "$repo_url" "cloned_repos/$repo_name"
          done < repos.txt

      - name: Run TruffleHog v3 on Cloned Repositories
        run: |
          echo "[*] TruffleHog version:"
          trufflehog --version

          for dir in cloned_repos/*; do
            if [ -d "$dir" ]; then
              echo "[+] Scanning $dir"
              trufflehog git --repo_path "$dir" --only-verified || echo "[!] Secrets may exist in $dir"
            fi
          done
