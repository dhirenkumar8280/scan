name: Secret Scan

on:
  push:
    paths:
      - repos.txt

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Latest TruffleHog & Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip jq

          # --- Install latest TruffleHog ---
          TRUFFLEHOG_VERSION=$(curl -s https://api.github.com/repos/trufflesecurity/trufflehog/releases/latest | jq -r .tag_name)
          curl -sSfL "https://github.com/trufflesecurity/trufflehog/releases/download/${TRUFFLEHOG_VERSION}/trufflehog_${TRUFFLEHOG_VERSION#v}_linux_amd64.tar.gz" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          sudo mv trufflehog /usr/local/bin/
          chmod +x /usr/local/bin/trufflehog

          # --- Install latest Notify ---
          NOTIFY_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/notify/releases/latest | jq -r .tag_name)
          curl -sSfL "https://github.com/projectdiscovery/notify/releases/download/${NOTIFY_VERSION}/notify_${NOTIFY_VERSION#v}_linux_amd64.zip" -o notify.zip
          unzip notify.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/notify

          # --- Configure Notify (Discord webhook) ---
          mkdir -p ~/.config/notify
          cat > ~/.config/notify/provider-config.yaml <<EOF
          discord:
            - id: "discord-webhook"
              discord_webhook_url: "https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"
          EOF

      - name: Run TruffleHog Scan
        run: |
          while read repo; do
            echo "Scanning $repo..."
            trufflehog git "$repo" --include-detectors="all" --json | notify -provider discord-webhook
          done < repos.txt
