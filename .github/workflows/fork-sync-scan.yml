name: Scan Repositories with TruffleHog

on:
  push:
    paths:
      - repos.txt  # Trigger only when repos.txt is changed

jobs:
  scan_repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v2

      - name: Install TruffleHog
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run TruffleHog on all repos in repos.txt
        run: |
          while read repo_url; do
            # Skip empty lines or lines starting with #
            if [[ -z "$repo_url" || "$repo_url" =~ ^# ]]; then
              continue
            fi

            echo ""
            echo "======================================"
            echo "[*] Scanning repo: $repo_url"
            echo "======================================"

            trufflehog git "$repo_url" \
              --include-detectors="all" \
              --print-avg-detector-time \
              --only-verified || echo "[!] Potential secrets found in $repo_url"

            echo "[âœ“] Done scanning $repo_url"
          done < repos.txt
