name: TruffleHog Secret Scan

on:
  workflow_dispatch:   # manual trigger
  push:                # auto trigger when repos.txt changes
    paths:
      - "repos.txt"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install TruffleHog & Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip

          # Install TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

          # Install Notify
          curl -sSfL https://github.com/projectdiscovery/notify/releases/download/v2.16.1/notify_2.16.1_linux_amd64.zip -o notify.zip
          unzip notify.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/notify

          # Create notify config (hardcoded Discord webhook)
          mkdir -p ~/.config/notify
          cat > ~/.config/notify/provider-config.yaml <<EOF
          discord:
            - id: "discord-webhook"
              discord_webhook_url: "https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"
          EOF

      - name: Run TruffleHog and send alerts
        run: |
          while read repo; do
            [ -z "$repo" ] && continue   # skip empty lines
            echo "[*] Scanning $repo ..."
            
            # Stream findings directly to notify
            trufflehog git --json "$repo" 2>/dev/null | notify -provider discord-webhook || true
          done < repos.txt
