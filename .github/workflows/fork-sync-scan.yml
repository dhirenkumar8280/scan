name: TruffleHog Secret Scan

on:
  workflow_dispatch:   # manual trigger
  push:                # auto trigger when repos.txt changes
    paths:
      - "repos.txt"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install TruffleHog and Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip jq

          # Install Trufflehog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Run TruffleHog on repos from repos.txt
        run: |
          mkdir -p results

          while read repo; do
            [ -z "$repo" ] && continue   # skip empty lines
            name=$(basename "$repo" .git)
            echo "[*] Scanning $repo ..."
            trufflehog git --json "$repo" > results/${name}.json || true
          done < repos.txt

      - name: Send notification if secrets found
        run: |
          WEBHOOK="https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"

          found_any=false

          for file in results/*.json; do
            repo=$(basename "$file" .json)
            count=$(jq length "$file")

            if [ "$count" -gt 0 ]; then
              found_any=true
              msg=":rotating_light: **$count secrets found** in repo: **$repo**"
              curl -s -H "Content-Type: application/json" \
                -X POST \
                -d "{\"content\": \"$msg\"}" \
                "$WEBHOOK"
            fi
          done

          if [ "$found_any" = false ]; then
            echo "âœ… No secrets found in any repo. No notification sent."
          fi
