name: Scan Repositories with TruffleHog + Notify

on:
  push:
    paths:
      - repos.txt

jobs:
  scan_repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v2

      - name: Install TruffleHog and Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin
          curl -sSfL https://github.com/projectdiscovery/notify/releases/download/v0.31.0/notify_0.31.0_linux_amd64.zip \
            -o notify.zip
          unzip notify.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/notify

      - name: Add notify config
        run: |
          mkdir -p ~/.config/notify
          cat <<'EOF' > ~/.config/notify/provider-config.yaml
          discord:
            - id: "alerts"
              discord_channel: "secrets-alerts"
              discord_webhook_url: "https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"
          EOF

      - name: Run TruffleHog Git Scan on repos.txt and Notify
        run: |
          while read repo_url; do
            if [[ -z "$repo_url" || "$repo_url" =~ ^# ]]; then
              continue
            fi

            echo "[+] Scanning $repo_url with TruffleHog"
            trufflehog git "$repo_url" --include-detectors="all" --print-avg-detector-time \
              > result.json 2>&1 || echo "[!] Scan failed for $repo_url"

            if [ -s result.json ]; then
              echo "[!] Sending findings for $repo_url to Discord"
              cat result.json | notify -silent -provider discord || true
            fi
          done < repos.txt
