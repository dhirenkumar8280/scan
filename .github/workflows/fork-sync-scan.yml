name: TruffleHog Secret Scan

on:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install TruffleHog and Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip jq

          # Install Trufflehog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

          # Install latest Notify
          LATEST_NOTIFY=$(curl -s https://api.github.com/repos/projectdiscovery/notify/releases/latest \
            | grep "browser_download_url.*linux_amd64.zip" | cut -d '"' -f 4)
          curl -sL "$LATEST_NOTIFY" -o notify.zip
          unzip notify.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/notify

      - name: Run TruffleHog on repos from repos.txt
        run: |
          mkdir -p results

          while read repo; do
            [ -z "$repo" ] && continue   # skip empty lines
            name=$(basename "$repo" .git)
            echo "[*] Scanning $repo ..."
            trufflehog git --json "$repo" > results/${name}.json || true
          done < repos.txt

      - name: Send results to Discord
        run: |
          WEBHOOK="https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"

          for file in results/*.json; do
            repo=$(basename "$file" .json)
            count=$(jq length "$file")

            if [ "$count" -gt 0 ]; then
              msg=":rotating_light: Secrets found in **$repo** → $count issues"
            else
              msg="✅ No secrets in **$repo**"
            fi

            curl -s -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\": \"$msg\"}" \
              "$WEBHOOK"
          done
