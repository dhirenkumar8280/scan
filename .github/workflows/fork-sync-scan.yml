name: TruffleHog Scan

on:
  push:
    paths:
      - repos.txt
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install TruffleHog & Notify
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar unzip

          # Install TruffleHog
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

          # Install Notify (latest version)
          NOTIFY_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/notify/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl -sSfL "https://github.com/projectdiscovery/notify/releases/download/${NOTIFY_VERSION}/notify_${NOTIFY_VERSION#v}_linux_amd64.tar.gz" -o notify.tar.gz
          tar -xvf notify.tar.gz -C /usr/local/bin/ notify
          chmod +x /usr/local/bin/notify

          # Configure Notify with your Discord webhook
          mkdir -p ~/.config/notify
          cat > ~/.config/notify/provider-config.yaml <<EOF
          discord:
            - id: "discord-webhook"
              discord_webhook_url: "https://discord.com/api/webhooks/1408044956060352553/pLyDkTHduvYe2nfhFYdFdMqUi1nq7k59jswHHt2PfX7px7MwCo91Mgi5ElVQnoNWJP3D"
          EOF

      - name: Run TruffleHog on repos
        run: |
          while IFS= read -r repo; do
            echo "ðŸ” Scanning $repo"
            trufflehog git $repo --include-detectors="all" --json | notify -provider discord
          done < repos.txt
